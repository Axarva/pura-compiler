# Parser Bugs and Debugging Progress

## English

### 1. Type Declaration + Function Parsing Conflict
- **Problem:** A top-level function with a preceding type declaration sometimes fails to parse.
- **Example:**
pura
view : Int -> Html Msg
let view = model => {
  div [] [ ... ]
}

- **Error:** "Missing type declaration for function: view" or "unexpected TokIdentifier 'view'".
- **Cause:** Parser commits after parseTypeDeclaration, never backtracks to parseFunctionDefinition.
- **Observation:** Functions without type declarations or block-style functions parse correctly.

### 2. Expression-Style Functions and EOF
- Expression-style functions parse correctly only at the end of the file. Otherwise, following top-level declarations may confuse the parser.

### 3. Improvements: Pretty Error Reporting
- Added token stream and top-level declaration debug logs.
- Errors now report missing type declarations, duplicate functions, or unexpected tokens.
- Limitation: Position (line/column) of problematic tokens is not yet reported.

### 4. Status
- Expression-style and block-style functions work in most cases.
- Remaining: Backtracking around type declarations and proper position reporting.

---

## 日本語 (Concise)

### 1. 型宣言と関数定義の衝突
- **問題:** 型宣言付きトップレベル関数が正しくパースされないことがある。
- **原因:** parseTypeDeclaration が成功するとコミットされ、parseFunctionDefinition が試されない。

### 2. 式スタイル関数と EOF
- 式スタイル関数はファイル末尾でのみ正しくパースされる。

### 3. 改善点
- デバッグログ追加により、型宣言不足や重複関数、予期しないトークンを明確に表示。
- 制限: エラーの正確な位置は未対応。

### 4. 現状
- 式・ブロックスタイル関数はほとんどのケースで正しくパース可能。
- 残課題: 型宣言周りのバックトラッキング改善と位置情報表示。
