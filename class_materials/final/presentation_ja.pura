-- presentation_ja.pura (Final Update with Transitions)

-- 1. MODEL --------------------------------------------------------------------
initialModel : List String
let initialModel = ["0", "ÂæÆÁ©çË©¶È®ìÂãâÂº∑ÔºÅÔºÅ"]

-- 2. LOGIC & HELPERS ----------------------------------------------------------
changeSlide : List String -> Int -> List String
let changeSlide = model => delta =>
  let currentIdx = parseInt (head model) in
  let newIdx = currentIdx + delta in
  -- UPDATE: Max index increased to 12 for split slides
  let finalIdx = if newIdx < 0 then 0 else if newIdx > 12 then 12 else newIdx in
  cons (toString finalIdx) (tail model)

addTodo : List String -> List String
let addTodo = model =>
  let input = prompt "Êñ∞„Åó„ÅÑ„Çø„Çπ„ÇØÂêç:" in
  cons (head model) (cons input (tail model)) REQUIRES BrowserPrompt

removeTop : List String -> List String
let removeTop = model =>
  let slideIdx = head model in
  let todos = tail model in
  if isEmpty todos then model else cons slideIdx (tail todos)

mapTodos : (String -> Html String) -> List String -> List (Html String)
let mapTodos = f => list =>
  if isEmpty list then [] else cons (f (head list)) (mapTodos f (tail list))

update : String -> List String -> List String
let update = msg => model =>
  if msg == "NEXT" then changeSlide model 1
  else if msg == "PREV" then changeSlide model (0 - 1)
  else if msg == "ADD_TODO" then addTodo model
  else if msg == "DEL_TODO" then removeTop model
  else model

-- 3. VIEW HELPERS -------------------------------------------------------------

-- Standard Wrapper (Plays Entry Animation)
slideWrapper : List (Html String) -> Html String
let slideWrapper = content => 
  div [ htmlClass "slide-container" ] [
    div [ htmlClass "slide" ] content,
    div [ htmlClass "nav-controls" ] [
      button [ htmlOnClick "PREV", htmlClass "nav-btn" ] [ text "‚Üê" ],
      button [ htmlOnClick "NEXT", htmlClass "nav-btn" ] [ text "‚Üí" ]
    ]
  ]

-- Stable Wrapper (NO Animation - For Step 2 of split slides)
slideWrapperStable : List (Html String) -> Html String
let slideWrapperStable = content => 
  div [ htmlClass "slide-container" ] [
    -- Adds 'no-anim' class to prevent re-fading the left column
    div [ htmlClass "slide no-anim" ] content,
    div [ htmlClass "nav-controls" ] [
      button [ htmlOnClick "PREV", htmlClass "nav-btn" ] [ text "‚Üê" ],
      button [ htmlOnClick "NEXT", htmlClass "nav-btn" ] [ text "‚Üí" ]
    ]
  ]

fragmentClass : Bool -> String
let fragmentClass = isVisible => 
  if isVisible then "fragment visible" else "fragment"

codeSpan : String -> String -> Html String
let codeSpan = cls => txt => 
  div [ htmlClass ("inline-code " ++ cls) ] [ text txt ]

kw : String -> Html String
let kw = t => codeSpan "kw" t
str : String -> Html String
let str = t => codeSpan "str" t
fn : String -> Html String
let fn = t => codeSpan "fn" t
cmt : String -> Html String
let cmt = t => codeSpan "cmt" t
norm : String -> Html String
let norm = t => codeSpan "norm" t
line : List (Html String) -> Html String
let line = content => div [ htmlClass "code-line" ] content

-- 4. SLIDES -------------------------------------------------------------------

-- Slide 0: Title
viewTitle : Int -> Html String
let viewTitle = idx =>
  slideWrapper [
    h1 [ htmlClass "title" ] [ text "Pura" ],
    p [ htmlClass "subtitle" ] [ text "UIÊåáÂêëÈñ¢Êï∞ÂûãË®ÄË™û" ],
    p [] [ text "JavaScript„Çà„ÇäË™≠„Åø„ÇÑ„Åô„Åè„ÄÅ„ÄåÂûã„Äç„Åß„Éü„Çπ„ÇíÈò≤„Åê„ÄÇ" ]
  ]

-- Slide 1 & 2: The Problem (Split into Steps)
viewProblem : Int -> Html String
let viewProblem = step =>
  -- Use Stable wrapper for Step 2 so the Left column doesn't "blink"
  let wrapper = if step == 2 then slideWrapperStable else slideWrapper in
  
  wrapper [
    h1 [] [ text "Ë™≤È°åÔºöÂÆüË°åÊôÇ„ÅÆËÑÜÂº±ÊÄß" ],
    p [ htmlClass "subtitle" ] [ text "ÂãïÁöÑÂûã‰ªò„Åë„ÅåÂºï„ÅçËµ∑„Åì„ÅôÈùô„Åã„Å™„ÇãÂ§±Êïó" ],
    div [ htmlClass "two-column" ] [
        div [] [
            p [] [ text "JavaScript„ÅÆÂ†¥Âêà (ÂÆüË°åÊôÇ„Ç®„É©„Éº)" ],
            div [ htmlClass "code-block" ] [
                line [ kw "function", norm " calc(cart) {" ],
                line [ norm "  ", kw "let", norm " total ", kw "=", norm " 0;" ],
                line [ norm "  ", kw "for", norm " (", kw "let", norm " item ", kw "of", norm " cart.items) {" ],
                line [ norm "    ", cmt "// „Éê„Ç∞: \"10\" + 0 = \"010\"" ],
                line [ norm "    total ", kw "+=", norm " item.price;" ],
                line [ norm "  }" ],
                line [ norm "  ", kw "return", norm " total;" ],
                line [ norm "}" ]
            ]
        ],
        -- Only visible in Step 2
        div [ htmlClass (fragmentClass (step == 2)) ] [
             p [] [ text "‰∏ÄÊñπ„ÄÅPura„ÅßÂêå„Åò„Ç≥„Éº„Éâ„ÇíÊõ∏„Åè„Å®..." ],
             div [ htmlClass "code-block" ] [
                line [ kw "let", fn " calc", norm " ", kw "=", norm " total ", kw "=>", norm " price ", kw "=>" ],
                line [ norm "  total ", kw "+", norm " price" ]
             ],
             div [ htmlClass "error-box" ] [
                div [ htmlClass "error-title" ] [ text "üõë Type Mismatch Error" ],
                div [ htmlClass "error-msg" ] [ text "Cannot add types Int and String." ],
                div [ htmlClass "error-detail" ] [ text "  | total + price" ],
                div [ htmlClass "error-detail" ] [ text "  |         ^^^^^ Expected Int, got String" ]
             ]
        ]
    ]
  ]

-- Slide 3: PRE-REVEAL
viewPreReveal : Int -> Html String
let viewPreReveal = idx =>
  slideWrapper [
    div [ htmlClass "center-suspense" ] [
        h1 [ htmlClass "wait-text" ] [ text "ÂÆü„ÅØ..." ],
        p [ htmlClass "wait-sub" ] [ text "„ÅäÊ∞ó„Å•„Åç„Åß„Åó„Çá„ÅÜ„ÅãÔºü" ]
    ]
  ]

-- Slide 4: THE REVEAL
viewReveal : Int -> Html String
let viewReveal = idx =>
  slideWrapper [
    div [ htmlClass "fragment visible" ] [
        h1 [ htmlClass "title reveal-title" ] [ text "„Åì„ÅÆ„Éó„É¨„Çº„É≥Ëá™‰Ωì„Åå PuraË£Ω „Åß„Åô„ÄÇ" ],
        p [] [ text "MVU „Ç¢„Éº„Ç≠„ÉÜ„ÇØ„ÉÅ„É£„Çí‰Ωø„Å£„ÅüÁä∂ÊÖãÁÆ°ÁêÜÊ©üËÉΩ‰ªò„Åç„Ç¢„Éó„É™„Åß„Åô„ÄÇ" ],
        div [ htmlClass "code-block reveal-code" ] [
             line [ norm " " ],
             line [ kw "let", fn " viewReveal", norm " ", kw "=", norm " idx ", kw "=>" ],
             line [ norm "  slideWrapper [" ],
             line [ norm "    h1 [] [ text ", str "\"„Åì„ÅÆ„Éó„É¨„Çº„É≥Ëá™‰Ωì„Åå...\"", norm " ]" ],
             line [ norm "  ]" ]
        ],
        div [ htmlClass "stats-container" ] [
            p [] [ text "JavaScript: 0Ë°å" ],
            p [] [ text "Runtime Errors: 0" ]
        ],
        div [ htmlClass "repo-link-container" ] [
            a [ htmlHref "https://github.com/Axarva/pura-compiler/tree/main/docs", htmlClass "repo-link" ] [
                text "Check Source on GitHub" 
            ]
        ]
    ]
  ]

-- Slide 5: Demo
viewTodoItem : String -> Html String
let viewTodoItem = item =>
  li [ htmlClass "todo-item" ] [ text item ]

viewDemo : List String -> Html String
let viewDemo = model =>
  slideWrapper [
    h1 [ htmlClass "title" ] [ text "ÂÆüË®º„Éá„É¢" ],
    p [] [ text "‰ª•‰∏ã„ÅÆ„Ç¢„Éó„É™„ÅØ Pura Runtime ‰∏ä„ÅßÂãï‰Ωú„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ" ],
    div [ htmlClass "todo-container" ] [
      ul [] (mapTodos viewTodoItem (tail model))
    ],
    div [] [
      button [ htmlOnClick "ADD_TODO", htmlClass "btn-primary" ] [ text "+ „Çø„Çπ„ÇØËøΩÂä†" ],
      text " ", 
      button [ htmlOnClick "DEL_TODO", htmlClass "btn-secondary" ] [ text "ÂÖàÈ†≠„ÇíÂÆå‰∫Ü" ]
    ]
  ]

-- Slide 6 & 7: Comparison (Split into Steps)
viewComparison : Int -> Html String
let viewComparison = step =>
  let wrapper = if step == 2 then slideWrapperStable else slideWrapper in

  wrapper [
    h1 [] [ text "ÊØîËºÉÂàÜÊûê" ],
    div [ htmlClass "two-column" ] [
      div [] [
        div [ htmlClass "col-header" ] [ text "JavaScript (ÂëΩ‰ª§Âûã)" ],
        div [ htmlClass "code-block" ] [
          line [ kw "function", fn " sum", norm "(list) {" ],
          line [ norm "  ", kw "let", norm " total ", kw "=", norm " 0;" ],
          line [ norm "  ", kw "for", norm " (", kw "let", norm " i", kw "=", norm "0; i<list.length; i++) {" ],
          line [ norm "    total ", kw "+=", norm " list[i];" ],
          line [ norm "  }" ],
          line [ norm "  ", kw "return", norm " total;" ],
          line [ norm "}" ]
        ]
      ],
      -- Only visible in Step 2
      div [ htmlClass (fragmentClass (step == 2)) ] [
        div [ htmlClass "col-header" ] [ text "Pura (ÂÆ£Ë®ÄÂûã)" ],
        div [ htmlClass "code-block" ] [
          line [ kw "let", fn " sum", norm " ", kw "=", norm " list ", kw "=>" ],
          line [ norm "  ", kw "if", norm " isEmpty list ", kw "then" ],
          line [ norm "    0" ],
          line [ norm "  ", kw "else" ],
          line [ norm "    head list ", kw "+", norm " sum (tail list)" ]
        ]
      ]
    ],
    -- Conclusion text also appears in Step 2
    div [ htmlClass (fragmentClass (step == 2)) ] [
        p [] [ text "„ÄåÊâãÈ†Ü„Äç„Åß„ÅØ„Å™„Åè„ÄåÂÆöÁæ©„Äç„ÇíÊõ∏„Åè„Åì„Å®„Åß„ÄÅÁä∂ÊÖãÁÆ°ÁêÜ„ÅÆ„Éê„Ç∞„ÇíÊéíÈô§„Åó„Åæ„Åô„ÄÇ" ]
    ]
  ]

-- Slide 8: Inference
viewInference : Int -> Html String
let viewInference = idx =>
  slideWrapper [
    h1 [] [ text "Hindley-Milner ÂûãÊé®Ë´ñ" ],
    p [ htmlClass "subtitle" ] [ text "„Ç≥„É≥„Éë„Ç§„É´ÊôÇ„Å´„Åä„Åë„ÇãÊ≠£ÂΩìÊÄß„ÅÆ‰øùË®º" ],
    ul [] [
      li [ htmlClass (fragmentClass (idx >= 1)) ] [ text "ÂûãÊé®Ë´ñ + ÊòéÁ§∫ÁöÑÂ•ëÁ¥ÑÔºöÂÜÖÈÉ®„ÅØÂÆåÂÖ®Êé®Ë´ñ„ÄÅÂ¢ÉÁïå„ÅØÊòéÁ§∫ÁöÑ" ],
      li [ htmlClass (fragmentClass (idx >= 2)) ] [ text "‰∏ªË¶ÅÂûã (Principal Types)ÔºöÊúÄ„ÇÇÊ±éÁî®ÁöÑ„Å™Âûã„ÇíÁâπÂÆö" ],
      li [ htmlClass (fragmentClass (idx >= 3)) ] [ text "ÂÆüË°åÊôÇ„Ç®„É©„Éº„Çº„É≠ÔºöÂûã‰ªò„Åë„Åï„Çå„Åü„Éó„É≠„Ç∞„É©„É†„ÅØË™§‰ΩúÂãï„Åó„Å™„ÅÑ" ]
    ]
  ]

-- Slide 9: Effects
viewEffects : Int -> Html String
let viewEffects = idx =>
  slideWrapper [
    h1 [] [ text "ÂâØ‰ΩúÁî®„ÅÆÁÆ°ÁêÜ (Effects)" ],
    p [ htmlClass "subtitle" ] [ text "Â§ñÈÉ®‰∏ñÁïå„Å∏„ÅÆ„Ç¢„ÇØ„Çª„Çπ„ÇíÊòéÁ§∫ÁöÑ„Å´Âà∂Âæ°" ],
    ul [] [
      li [ htmlClass "fragment visible" ] [ text "JavaScript„Å®„ÅØÁï∞„Å™„Çä„ÄÅÂâØ‰ΩúÁî®„ÅØÊòéÁ§∫ÁöÑ„Åß„Åô„ÄÇ" ],
      li [ htmlClass "fragment visible" ] [ text "Èñ¢Êï∞„ÅØÂøÖË¶Å„Å™„ÄåÊ®©Èôê„Äç„ÇíÂÆ£Ë®Ä„Åó„Å™„Åë„Çå„Å∞„Å™„Çä„Åæ„Åõ„Çì„ÄÇ" ]
    ],
    div [ htmlClass "code-block" ] [
      line [ cmt "-- 'main' Èñ¢Êï∞„ÅØÂÆüË°å„Å´ÁâπÂÆö„ÅÆÊ®©Èôê„ÇíË¶ÅÊ±Ç„Åô„Çã" ],
      line [ kw "let", fn " main", norm " ", kw "=", norm " { ... }" ],
      line [ kw "  REQUIRES", norm " ConsoleWrite, BrowserPrompt" ]
    ]
  ]

-- Slide 10: Roadmap
viewRoadmap : Int -> Html String
let viewRoadmap = idx =>
  slideWrapper [
    h1 [] [ text "‰ªäÂæå„ÅÆÂ±ïÊúõ" ],
    ul [] [
      li [ htmlClass "fragment visible" ] [ text "‰ª£Êï∞ÁöÑ„Ç®„Éï„Çß„ÇØ„Éà (Algebraic Effects)" ],
      li [ htmlClass "fragment visible" ] [ text "WebAssembly (Wasm) „Éê„ÉÉ„ÇØ„Ç®„É≥„Éâ" ],
      li [ htmlClass "fragment visible" ] [ text "Ê®ôÊ∫ñ„É©„Ç§„Éñ„É©„É™„ÅÆÊã°ÂÖÖ" ]
    ]
  ]

-- Slide 11: Conclusion
viewConclusion : Int -> Html String
let viewConclusion = idx =>
  slideWrapper [
    h1 [ htmlClass "title" ] [ text "ÁµêË´ñ" ],
    p [ htmlClass "subtitle" ] [ text "Pura„ÅØ„ÄÅÂé≥ÂØÜ„Å™ÂûãÁêÜË´ñ„Åå" ],
    p [ htmlClass "subtitle" ] [ text "Áèæ‰ª£„ÅÆ„Ç§„É≥„Çø„É©„ÇØ„ÉÜ„Ç£„Éñ„Å™UIÈñãÁô∫„Å®ÂÖ±Â≠ò„Åß„Åç„Çã„Åì„Å®„ÇíÁ§∫„Åó„Åæ„Åó„Åü„ÄÇ" ]
  ]

-- Slide 12: Thank You
viewEnd : Int -> Html String
let viewEnd = idx =>
  slideWrapper [
    h1 [ htmlClass "title" ] [ text "„ÅîÊ∏ÖËÅ¥„ÅÇ„Çä„Åå„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åó„Åü„ÄÇ" ],
    p [ htmlClass "subtitle" ] [ text "Ë≥™ÁñëÂøúÁ≠î" ],
    p [] [ text "Built with Pura Compiler 2025" ]
  ]

-- 6. MAIN DISPATCH ------------------------------------------------------------
view : List String -> Html String
let view = model =>
  let idx = parseInt (head model) in
  
  -- Mapped consecutive indices to Steps (e.g., 1->Problem1, 2->Problem2)
  if idx == 0 then viewTitle idx
  else if idx == 1 then viewProblem 1
  else if idx == 2 then viewProblem 2
  else if idx == 3 then viewPreReveal idx
  else if idx == 4 then viewReveal idx
  else if idx == 5 then viewDemo model
  else if idx == 6 then viewComparison 1
  else if idx == 7 then viewComparison 2
  else if idx == 8 then viewInference 3
  else if idx == 9 then viewEffects idx
  else if idx == 10 then viewRoadmap idx
  else if idx == 11 then viewConclusion idx
  else viewEnd idx

-- 7. ENTRY POINT --------------------------------------------------------------
main : Unit
let main = {
  print "Starting University Rehearsal (JP)..."
} REQUIRES ConsoleWrite, BrowserPrompt
